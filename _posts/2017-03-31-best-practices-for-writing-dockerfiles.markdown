---
layout:     post
title:      "编写dockerfiles最佳实践"
keywords:   "dockerfile,最佳实践,经验" 
description: "编写dockerfiles最佳实践"
date:       2017-03-31
published:  false 
catalog: true
tags:
    - docker 
---

Docker可以通过dockerfile读取指令来自动构建镜像，它是一个包含构建给定镜像所需指令的文本文件。Dockerfiles遵循特定的格式并使用一组特定的指令。

## 一般准则和建议
#### 容器应该是短暂的
由Dockerfile定义的镜像生成的容器应尽可能短暂。对于“短暂”这个词，我们指的是容器可以被停止和销毁，并且使用最小的设置和配置来创建一个新的容器。你可能需要查看应用程序方法“12要素”的Processes部分，以了解在这样一个无状态方式运行容器的意义。

#### 使用`.dockerignore`
在大多数情况下，最好将dockerfile放在一个空目录中，然后，仅添加构建dockerfile所需的文件。要提升构建的性能，你也可以添加一个`.dockerignore`文件到该目录来排除文件和目录。这个文件的用法类似于`.gitignore`。

#### 避免安装不必要的包
为了减少复杂性、依赖性、文件大小和构建时间，你应该避免安装额外的或不必要的包，即使装了某个包会更好。例如，你不需要在一个数据库镜像中安装VIM。

#### 每个容器应该只有一个关注点
将应用程序解耦到多个容器中可以更方便地对容器进行水平扩展和重用。例如，一个Web应用可能由三个独立的容器组成，每个容器都拥有自己的镜像，这就是以解耦方式来管理Web应用，数据库和缓存。

你可能已经听说`一个容器一个进程`的经验法则，虽然其意图很好，但并不是说每个容器只能有一个进程。事实上，除了容器可以被init进程生成外，一些程序可能会自行产生其他的进程。例如，Celery可以产生多个进程，Apache也可以根据每个请求来创建一个进程。通常来讲，`一个容器一个进程`是很好的经验法则，但它不是固定的，你应该根据自己的最佳判断来保持容器尽可能干净、模块化。

如果容器之间相互依赖，你可能使用`Docker container networks`来确保容器之间可以通信。

#### 最小化镜像层
在编写dockerfile时，你需要综合考虑`Dockerfile`文件可读性（为了长期维护）和最小化镜像层数。

#### 对多行参数排序
无论什么时候，尽可能地通过首字母来排序多行参数，这会让你避免安装重复的包，使得参数列表更容易来维护。在反斜杠`\`前添加一个空格，也将让dockerfile更易阅读和review。

下面有个例子：
```
RUN apt-get update && apt-get install -y \
    bzr \
    cvs \
    git \
    mercurial \
    subversion
```
#### 构建缓存
在构建镜像的过程中，Docker将按照指定的顺序逐步执行Dockerfile中的指令。随着每条指令的检查，Docker将在其缓存中查找可以重用的现有镜像，而不是创建一个新的（重复）镜像。如果你不想使用缓存，可以在`docker build`命令中使用`--no-cache = true`选项。

但是，如果你确实要让Docker使用其缓存，那么了解何时会找到匹配的镜像是非常重要的。 Docker查找镜像缓存时将遵循的基本规则如下：
